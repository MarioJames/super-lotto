# Implementation Plan

- [x] 1. 数据库结构变更
  - [x] 1.1 修改 participants 表结构
    - 添加 `activity_id` 字段（NOT NULL，外键）
    - 添加级联删除约束
    - 修改 employee_id 唯一性约束为活动内唯一
    - _Requirements: 5.1, 5.4_
  - [x] 1.2 修改 rounds 表结构
    - 添加 `animation_duration_ms` 字段（默认值 60000）
    - _Requirements: 6.1, 6.4_
  - [x] 1.3 修改 activities 表结构
    - 移除 `animation_duration_ms` 字段
    - _Requirements: 6.5_
  - [x] 1.4 删除 activity_participants 关联表
    - _Requirements: 5.1_
  - [x] 1.5 更新数据库类型定义文件
    - 更新 `src/lib/db/types.ts`
    - _Requirements: 5.1, 5.2_

- [x] 2. 更新类型定义和数据模型
  - [x] 2.1 更新 Participant 类型
    - 添加 activityId 字段
    - 修改 ParticipantCSVRow 字段为可选（除 name 外）
    - _Requirements: 5.1, 1.4_
  - [x] 2.2 更新 Activity 类型
    - 移除 animationDurationMs 字段
    - _Requirements: 6.5_
  - [x] 2.3 更新 Round 类型
    - 添加 animationDurationMs 字段
    - _Requirements: 6.1_
  - [x] 2.4 更新 DTO 类型
    - 修改 CreateActivityDTO 支持 participants 数组
    - 修改 CreateRoundDTO 和 UpdateRoundDTO 添加 animationDurationMs
    - _Requirements: 1.6, 6.1, 6.2_

- [x] 3. 更新 Repository 层
  - [x] 3.1 重构 ParticipantRepository
    - 修改所有查询方法支持 activityId 过滤
    - 添加 `createForActivity(activityId, data)` 方法
    - 添加 `importForActivity(activityId, csvRows)` 方法
    - 移除全局操作方法
    - _Requirements: 2.1, 2.2, 4.2_
  - [ ]* 3.2 编写 ParticipantRepository 属性测试
    - **Property 2: 活动级人员隔离**
    - **Validates: Requirements 2.1, 2.2**
  - [x] 3.3 更新 ActivityRepository
    - 修改 create 方法支持直接创建参与人员
    - 移除 addParticipants/removeParticipants 方法
    - 更新 findWithRounds 方法
    - _Requirements: 1.6, 2.1_
  - [ ]* 3.4 编写 ActivityRepository 属性测试
    - **Property 3: 活动删除级联清理**
    - **Validates: Requirements 2.3, 5.4**
  - [x] 3.5 更新 RoundRepository
    - 添加 animationDurationMs 字段处理
    - _Requirements: 6.1, 6.2_
  - [ ]* 3.6 编写 RoundRepository 属性测试
    - **Property 7: 轮次动画时长默认值**
    - **Property 8: 轮次动画时长更新**
    - **Validates: Requirements 6.2, 6.4**

- [x] 4. 更新 Service 层
  - [x] 4.1 重构 ParticipantService
    - 添加 `importParticipantsForActivity(activityId, csvContent)` 方法
    - 添加 `deleteParticipantFromActivity(activityId, participantId)` 方法
    - 修改 CSV 解析逻辑，仅 name 必填
    - 移除全局操作方法
    - _Requirements: 1.3, 1.4, 1.5, 4.2, 4.3_
  - [ ]* 4.2 编写 CSV 解析属性测试
    - **Property 1: CSV解析往返一致性**
    - **Property 9: 仅姓名必填验证**
    - **Validates: Requirements 1.3, 1.4, 1.5**
  - [x] 4.3 更新 ActivityService
    - 修改 createActivity 支持直接创建参与人员
    - 移除 animationDurationMs 相关逻辑
    - 添加参与人员数量验证
    - _Requirements: 1.6, 1.7, 6.5_
  - [ ]* 4.4 编写 ActivityService 属性测试
    - **Property 4: 同一人员多活动独立性**
    - **Property 5: CSV追加导入累加性**
    - **Validates: Requirements 2.4, 4.2**
  - [x] 4.5 更新 RoundService
    - 添加 animationDurationMs 字段处理
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 4.6 更新 LotteryService
    - 使用轮次的 animationDurationMs
    - _Requirements: 6.3_

- [x] 5. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. 更新 API 层
  - [x] 6.1 移除全局参与人员 API
    - 删除 `src/app/api/participants/route.ts`
    - 删除 `src/app/api/participants/[id]/route.ts`
    - 删除 `src/app/api/participants/import/route.ts`
    - _Requirements: 3.3_
  - [x] 6.2 更新活动 API
    - 修改 POST `/api/activities` 支持 participants 数组
    - _Requirements: 1.6_
  - [x] 6.3 添加活动参与人员 API
    - 更新 GET `/api/activities/[id]/participants`
    - 添加 POST `/api/activities/[id]/participants/import`
    - 添加 DELETE `/api/activities/[id]/participants/[participantId]`
    - _Requirements: 4.1, 4.2, 4.3_
  - [x] 6.4 更新轮次 API
    - 修改 POST `/api/activities/[id]/rounds` 支持 animationDurationMs
    - 修改 PUT `/api/rounds/[id]` 支持 animationDurationMs
    - _Requirements: 6.1, 6.2_
  - [x] 6.5 添加 CSV 模板下载 API
    - 添加 GET `/api/templates/participants`
    - _Requirements: 1.2_

- [x] 7. 更新前端组件
  - [x] 7.1 移除参与人员页面
    - 删除 `src/app/participants/page.tsx`
    - _Requirements: 3.1_
  - [x] 7.2 更新侧边栏导航
    - 移除"参与人员"导航项
    - _Requirements: 3.1_
  - [x] 7.3 添加 /participants 重定向
    - 创建重定向到 /activities
    - _Requirements: 3.2_
  - [x] 7.4 更新活动创建弹窗
    - 添加 CSV 模板下载链接
    - 添加 CSV 文件上传和预览功能
    - 移除参与人员选择列表
    - 移除动画时长配置
    - _Requirements: 1.1, 1.2, 1.3, 6.5_
  - [x] 7.5 更新活动详情页
    - 添加参与人员列表展示
    - 添加 CSV 追加导入功能
    - 添加参与人员删除功能
    - 移除活动级动画时长显示
    - _Requirements: 4.1, 4.2, 4.3, 6.5_
  - [x] 7.6 更新轮次配置表单
    - 添加动画时长配置字段
    - _Requirements: 6.1, 6.2_
  - [ ]* 7.7 编写参与人员删除属性测试
    - **Property 6: 参与人员删除正确性**
    - **Validates: Requirements 4.3**

- [x] 8. 更新抽奖页面
  - [x] 8.1 修改抽奖动画时长获取逻辑
    - 从轮次配置获取 animationDurationMs
    - _Requirements: 6.3_

- [ ] 9. Final Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

