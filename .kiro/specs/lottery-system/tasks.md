# Implementation Plan

- [x] 1. 项目初始化和基础设施搭建
  - [x] 1.1 创建 Next.js 15 项目并配置 TypeScript
    - 使用 `create-next-app` 创建项目，启用 App Router
    - 配置 TypeScript 严格模式
    - 安装依赖：better-sqlite3, csv-parse, csv-stringify, framer-motion
    - _Requirements: 8.1_
  - [x] 1.2 配置 Tailwind CSS 和 shadcn/ui
    - 初始化 Tailwind CSS
    - 安装并配置 shadcn/ui 组件库
    - 添加基础 UI 组件（Button, Input, Table, Dialog, Card 等）
    - _Requirements: 7.1_
  - [x] 1.3 创建数据库连接和表结构
    - 实现 SQLite 数据库连接模块
    - 创建所有数据表（participants, activities, rounds, winners, activity_participants）
    - 实现数据库初始化逻辑
    - _Requirements: 8.1, 8.2_
  - [ ]* 1.4 配置 Vitest 和 fast-check 测试框架
    - 安装 vitest 和 fast-check
    - 配置测试环境和测试数据库
    - _Requirements: 8.1_

- [x] 2. 核心类型定义和数据仓库层
  - [x] 2.1 创建核心类型定义
    - 定义 Participant, Activity, Round, Winner 等接口
    - 定义 LotteryMode 枚举
    - 定义 DTO 类型和 API 响应类型
    - 定义错误类型
    - _Requirements: 1.2, 3.1, 4.1_
  - [x] 2.2 实现参与人员仓库 (ParticipantRepository)
    - 实现 CRUD 操作
    - 实现 CSV 数据导入方法
    - 实现按活动查询参与人员
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_
  - [ ]* 2.3 编写参与人员仓库属性测试
    - **Property 1: 参与人员 CRUD 往返一致性**
    - **Property 2: 参与人员删除完整性**
    - **Validates: Requirements 1.2, 1.3, 1.4, 1.5**
  - [x] 2.4 实现活动仓库 (ActivityRepository)
    - 实现 CRUD 操作
    - 实现级联删除（删除活动时删除关联轮次和中奖记录）
    - 实现查询活动详情（含轮次）
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [ ]* 2.5 编写活动仓库属性测试
    - **Property 4: 活动 CRUD 往返一致性**
    - **Property 5: 活动级联删除完整性**
    - **Validates: Requirements 3.1, 3.2, 3.3, 3.4, 3.5**
  - [x] 2.6 实现轮次仓库 (RoundRepository)
    - 实现 CRUD 操作
    - 实现按活动查询轮次（按 orderIndex 排序）
    - 实现级联删除（删除轮次时删除中奖记录）
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [ ]* 2.7 编写轮次仓库属性测试
    - **Property 6: 轮次排序一致性**
    - **Property 7: 轮次级联删除完整性**
    - **Validates: Requirements 4.3, 4.4**
  - [x] 2.8 实现中奖记录仓库 (WinnerRepository)
    - 实现创建中奖记录
    - 实现按轮次/活动/参与人员查询
    - _Requirements: 5.2, 5.3_

- [ ] 3. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. 业务服务层实现
  - [x] 4.1 实现参与人员服务 (ParticipantService)
    - 实现 CSV 文件导入（解析文件、验证数据、批量导入）
    - 实现参与人员 CRUD 操作
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_
  - [ ]* 4.2 编写 CSV 导入属性测试
    - **Property 3: CSV 导入有效数据保留**
    - **Validates: Requirements 1.1, 1.6**
  - [x] 4.3 实现活动服务 (ActivityService)
    - 实现活动 CRUD 操作
    - 实现活动参与人员关联管理
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [x] 4.4 实现轮次服务 (RoundService)
    - 实现轮次 CRUD 操作
    - 实现轮次排序管理
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [x] 4.5 实现抽奖服务 (LotteryService)
    - 实现随机抽奖算法
    - 实现可用参与人员池计算（考虑多次中奖配置）
    - 实现中奖人数边界检查
    - 实现中奖结果存储
    - _Requirements: 2.1, 2.2, 2.3, 4.5, 5.1, 5.2_
  - [ ]* 4.6 编写抽奖服务属性测试
    - **Property 8: 抽奖人数边界检查**
    - **Property 9: 抽奖结果数量正确性**
    - **Property 10: 抽奖结果来源有效性**
    - **Property 11: 禁用多次中奖时的排除规则**
    - **Property 12: 启用多次中奖时的包含规则**
    - **Property 13: 中奖结果持久化往返**
    - **Validates: Requirements 2.1, 2.2, 2.3, 4.5, 5.1, 5.2, 5.3**
  - [x] 4.7 实现导出服务 (ExportService)
    - 实现中奖结果 CSV 导出
    - 包含活动名称、轮次、奖品、中奖人员信息
    - _Requirements: 5.4_
  - [ ]* 4.8 编写导出服务属性测试
    - **Property 14: 导出数据完整性**
    - **Validates: Requirements 5.4**

- [ ] 5. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. API 路由层实现
  - [x] 6.1 实现参与人员 API 路由
    - GET /api/participants - 获取参与人员列表
    - POST /api/participants - 创建参与人员
    - POST /api/participants/import - CSV 批量导入
    - PUT /api/participants/[id] - 更新参与人员
    - DELETE /api/participants/[id] - 删除参与人员
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [x] 6.2 实现活动 API 路由
    - GET /api/activities - 获取活动列表
    - GET /api/activities/[id] - 获取活动详情（含轮次）
    - POST /api/activities - 创建活动
    - PUT /api/activities/[id] - 更新活动
    - DELETE /api/activities/[id] - 删除活动
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [x] 6.3 实现轮次 API 路由
    - GET /api/activities/[id]/rounds - 获取活动轮次
    - POST /api/activities/[id]/rounds - 添加轮次
    - PUT /api/rounds/[id] - 更新轮次
    - DELETE /api/rounds/[id] - 删除轮次
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [x] 6.4 实现抽奖 API 路由
    - POST /api/lottery/draw - 执行抽奖
    - GET /api/lottery/results/[roundId] - 获取轮次中奖结果
    - GET /api/lottery/available/[activityId] - 获取可用参与人员
    - _Requirements: 5.1, 5.2, 5.3_
  - [x] 6.5 实现导出 API 路由
    - GET /api/export/activity/[id] - 导出活动中奖结果
    - GET /api/export/round/[id] - 导出轮次中奖结果
    - _Requirements: 5.4_

- [x] 7. 前端页面和组件实现
  - [x] 7.1 创建应用布局和导航
    - 实现根布局组件
    - 实现侧边栏导航（参与人员管理、活动管理）
    - 实现响应式设计
    - _Requirements: 7.1, 7.2_
  - [x] 7.2 实现参与人员管理页面
    - 参与人员列表展示（表格）
    - 添加/编辑参与人员对话框
    - CSV 文件上传导入
    - 删除确认
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [x] 7.3 实现活动管理页面
    - 活动列表展示（卡片）
    - 创建/编辑活动对话框
    - 活动详情页面
    - 轮次配置（添加/编辑/删除/排序）
    - 参与人员选择
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4_


- [x] 8. 抽奖动画组件实现
  - [x] 8.1 实现双色球抽奖动画组件
    - 模拟双色球开奖动画
    - 依次显示每个中奖者对应的号码球
    - 支持可配置动画时长
    - _Requirements: 6.1_
  - [x] 8.2 实现刮刮乐抽奖动画组件
    - 显示可刮开的卡片界面
    - 刮开效果动画
    - 刮开后显示中奖者信息
    - 支持可配置动画时长
    - _Requirements: 6.2_
  - [x] 8.3 实现祖玛抽奖动画组件
    - 显示旋转的球链动画
    - 球停止时显示中奖者
    - 支持可配置动画时长
    - _Requirements: 6.3_
  - [x] 8.4 实现赛马抽奖动画组件
    - 显示赛马竞速动画
    - 到达终点的顺序决定中奖者
    - 支持可配置动画时长
    - _Requirements: 6.4_
  - [x] 8.5 实现转盘抽奖动画组件
    - 显示旋转轮盘动画
    - 指针停止位置决定中奖者
    - 支持可配置动画时长
    - _Requirements: 6.5_
  - [x] 8.6 实现老虎机抽奖动画组件
    - 显示三列滚动动画
    - 停止后匹配的图案对应中奖者
    - 支持可配置动画时长
    - _Requirements: 6.6_

- [x] 9. 抽奖执行页面实现
  - [x] 9.1 实现抽奖执行页面框架
    - 显示活动信息和轮次列表
    - 显示当前轮次状态
    - 显示可用参与人员数量
    - _Requirements: 5.1, 7.1_
  - [x] 9.2 实现抽奖流程控制器
    - 开始活动自动进入第一轮
    - 当前轮完成后自动进入下一轮
    - 支持暂停/恢复
    - 显示轮次进度
    - _Requirements: 5.1, 6.1-6.6_
  - [x] 9.3 实现中奖结果展示
    - 显示每轮中奖者列表
    - 显示中奖者详细信息
    - 支持导出中奖结果
    - _Requirements: 5.3, 5.4_

- [ ] 10. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 11. 集成和优化
  - [x] 11.1 实现错误处理和用户反馈
    - 统一错误处理
    - Toast 通知
    - 加载状态
    - _Requirements: 7.3, 8.3_
  - [x] 11.2 实现数据验证
    - 前端表单验证
    - API 参数验证
    - _Requirements: 1.6, 4.5_
  - [ ]* 11.3 编写数据库事务属性测试
    - **Property 15: 数据库事务一致性**
    - **Property 16: 数据持久化往返**
    - **Validates: Requirements 8.2, 8.3, 8.4**

- [ ] 12. Final Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.
